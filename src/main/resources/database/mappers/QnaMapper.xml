<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.winter.app.board.qna.QnaDAO">
  	<!-- reply step update
  		원래 원본 스텝0 에 답글을 달면 스텝1이 되는데
  		또 다른 원본 답글이 생기면 스텝1이 중복이된다. 그래서 정렬을 할 수 없다.
  		옛날 답글은 아래로 내려가야하기때문에 위와같은 상황이 생기면
  		옛날 답글에 스텝+1을 해주는것이다 .
  	 -->
  	<update id="setReplyUpdate" parameterType="QnaDTO">
  		UPDATE QNA SET NOTICE_STEP = (NOTICE_STEP+1)
  		WHERE NOTICE_REF = #{notice_Ref} AND NOTICE_STEP > #{notice_Step}
  	</update>
  
  	<!-- reply add -->
  	<insert id="setReplyAdd" parameterType="QnaDTO">
  		<selectKey keyProperty="notice_Num" order="BEFORE" resultType="Long">
  			SELECT QNA_SEQ.NEXTVAL FROM DUAL
  		</selectKey>
  		INSERT INTO QNA (NOTICE_NUM,NOTICE_TITLE,NOTICE_WRITTER,NOTICE_CONTENTS,NOTICE_REF,NOTICE_STEP,NOTICE_DEPTH)
  			 VALUES (#{notice_Num},#{notice_Title},#{notice_Writter},#{notice_Contents},#{notice_Ref},#{notice_Step},#{notice_Depth})
  		
  	</insert>
  
  	<select id="getList" resultType="QnaDTO" parameterType="Pager">
  	SELECT * FROM
  		(SELECT ROWNUM R, Q.* FROM
  		(SELECT * FROM QNA
  			ORDER BY NOTICE_REF DESC,NOTICE_STEP ASC) Q)  		
  	WHERE R BETWEEN #{start_num} AND #{last_num}
  	</select>
  	
  	<insert id="setFileAdd" parameterType="BoardFileDTO">
  		INSERT INTO QNAFILES VALUES(QNA_SEQ.NEXTVAL,#{notice_Num},#{fileName},#{oriName})
  	</insert>
  	
  	<insert id="setAdd" parameterType="BoardDTO">
  		<selectKey keyProperty="notice_Num" order="BEFORE" resultType="Long">
  			SELECT QNA_SEQ.NEXTVAL FROM DUAL
  		</selectKey>
  		INSERT INTO QNA (NOTICE_NUM,NOTICE_TITLE,NOTICE_WRITTER,NOTICE_CONTENTS,NOTICE_REF,NOTICE_STEP,NOTICE_DEPTH)
  		 VALUES (#{notice_Num},#{notice_Title},#{notice_Writter},#{notice_Contents},#{notice_Num},0,0)
  	</insert>
  	
  	<resultMap type="QnaDTO" id="QnaGetDetail">
  		<id column="NOTICE_NUM" property="notice_Num"></id>
  		<result column="NOTICE_TITLE" property="notice_Title"/>
  		<result column="NOTICE_CONTENTS" property="notice_Contents"/>
  		<result column="NOTICE_WRITTER" property="notice_Writter"/>
  		<result column="NOTICE_TIME" property="notice_Time"/>
  		<result column="NOTICE_VIEW" property="notice_View"/>
  		<result column="NOTICE_REF" property="notice_Ref"/>
  		<result column="NOTICE_STEP" property="notice_Step"/>
  		<result column="NOTICE_DEPTH" property="notice_Depth"/> 
  		<collection property="fileDTOs" javaType="List" ofType="BoardFileDTO">
  			<id column="FILENUM" property="fileNum"></id>
  			<result column="FILENAME" property="fileName"/>
  			<result column="ORINAME" property="oriName"/>
  		</collection>
  	
  	</resultMap>
 
  	<select id="getDetail" resultMap="QnaGetDetail" parameterType="BoardDTO">
  		SELECT * FROM QNA
  		LEFT OUTER JOIN
  		QNAFILES
  		USING (NOTICE_NUM)
  		WHERE NOTICE_NUM = #{notice_Num}
  	</select> 
  	
  	<update id="setUpdate" parameterType="BoardDTO">
  		UPDATE QNA
  		<set> 
  			<if test="notice_Title != ''">
  			NOTICE_TITLE = #{notice_Title},
  			</if>
  			<if test = "notice_Contents != null">	
  			NOTICE_CONTENTS = #{notice_Contents}
  			</if>
  		</set>
  		WHERE NOTICE_NUM = #{notice_Num}
  	</update>
  	
	<!-- 파일 삭제 -->  	
  	<!-- 파일 리스트 가져오기 -->
  	<select id="getFileList" resultType="BoardFileDTO" parameterType="BoardDTO">
  		SELECT FILENAME FROM QNAFILES WHERE NOTICE_NUM = #{notice_Num}
  	</select>
  	
  	<delete id="setFileDelete" parameterType="BoardDTO">
  		DELETE QNAFILES WHERE NOTICE_NUM = #{notice_Num}
  	</delete>
  	
  	<update id="setDelete" parameterType="QnaDTO">
  		UPDATE QNA SET FLAG = #{flag}
  	</update>
  </mapper>